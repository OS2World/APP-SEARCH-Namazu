#!/usr/local/bin/perl
{my($tmp)=$0;$tmp="./$tmp" if -e $tmp && $tmp !~ /[\/\\]/;while ($tmp =~ /^.*[\/\\]/){unshift(@INC, $&);last if !-l $tmp;$tmp=$& . $tmp if ($tmp=readlink($tmp)) !~ /^\//;}}
sub config{$Pnamazu = '98.12.16';
$IntType='';$Zcat='/usr/local/bin/gzip -dc';$ZcatPri=10;$Max=10;$Whence=0;$DbName='NMZ';$Format='long';$Sort="score";$ScriptName='';$NamazuConf='';$ReniceTime=0;$RenicePri=10;$CmdLineArg='new';$RemoteEnable = 0;
%DbAlias=();@DbEnable=();$RespTextOrig=0;$SplitLink=0;$ScriptName=$ENV{'SCRIPT_FILENAME'} if !$ScriptName;$ScriptName=$0 if !$ScriptName && $0 ne '-';($ScriptDir=$ScriptName) =~ s/[\\\/].*?$// if $ScriptName && !$ScriptDir;}
sub set_inttype{local(@db)=@_;push(@db, $DbPath);if (!$IntType){foreach $_ (@db){$IntType='N', last if -e "$_.be" && ! -e "$_.le";$IntType='V', last if -e "$_.le" && ! -e "$_.be";}}$IntType='I' if !$IntType;$IntPackFF=pack($IntType, -1);$IntSize=length($IntPackFF);$IntFF=unpack($IntType, $IntPackFF);foreach $_ (keys(%DbSize)){$DbNdx{$_}=$DbSize{$_} / $IntSize;}}
sub ssub{local($totalhit, *score, $key, $pat, $x, $flag)=@_;my($buf);my($str)=$buf=&readindexindex($x);$buf =~ s/[\xa1-\xfe]./\xff$&/g if $flag;if ($buf =~ /$pat/){my($net, $hit)=&readindexscore($x, *score, $str);$$totalhit += $hit;$SubHit{$key}{$net} .= "$str ";return 1;}return 0;}
sub binsearch{local($origkey, *score)=@_;my($x, $l, $r, $p, $buf, $hit, $totalhit, $pat);my($key)=$origkey;my($regsearch, $forward, $backward);if ($FIELD && ($fieldsearch=($key =~ /^\+[^\:\s]+\:/))){return &field_search($origkey, *score, $key);}if (!($regsearch=($key =~ s/^\/(.*)\/$/$1/))){$forward=($key =~ s/(.)\*$/$1/);$backward=($key =~ s/^\*(.)/$1/);}$pat=$key;if ($regsearch){return &reg_search($origkey, *score, $key) if $REG;$forward=$backward=1;$origkey="*$key*" }if ($backward){if ($BW){if ($key =~ /^([\xa1-\xfe][\xa1-\xfe])+$/){$Mb=&bwopen('MB', 'm') if $Mb < 0;return &bwsearch($origkey, *score, $key, $forward, 'MB') if $Mb;}if ($key =~ /^[\x21-\x7e]{2,}$/){$Sb=&bwopen('SB', 's') if $Sb < 0;return &bwsearch($origkey, *score, $key, $forward, 'SB') if $Sb;}&w_read("$DbPath.w");return &w_bw($origkey, *score, $key, $forward) if $Wdb > 0;}$origkey =~ s/^\*//;}$pat =~ s/[\x00-\x7f]+/quotemeta($&)/ge if $forward;
$x=ord($key) << 8;if ($key =~ /^.(.)/){$x |= ord($1);$r=&indexpointer(*HASH, 1 + $x) - 1;}elsif ($forward){$r=&indexpointer(*HASH, 0x100 + $x) - 1;}else{$r=&indexpointer(*HASH, 1 + $x) - 1;}$p=$l=&indexpointer(*HASH, $x);if ($l <= $r){while ($l <= $r){$x=int(($l + $r + 1) / 2);$buf=&readindexindex($x);if ($forward){if (&ssub(\$totalhit, *score, $origkey, $pat, ($p=$x))){while (&ssub(\$totalhit, *score, $origkey, $pat, --$x)){;}$x=$p;while (&ssub(\$totalhit, *score, $origkey, $pat, ++$x)){;}return ($origkey, '', $totalhit);}}elsif ($key eq $buf){$hit=&readindexscore($x, *score, $key);return ($key, '', $hit);}if ($key lt $buf){$r=$x - 1;}else{$l=$x + 1;}}if ($key =~ /^[\xa1-\xfe]*$/){while ($x >= $p){$buf=&readindexindex($x);if ($key =~ /^$buf/){$origkey =~ s/^$buf//;return ($buf, $origkey, &readindexscore($x, *score, $buf));}--$x;}}}return ($&, $origkey, 0) if $origkey =~ s/^\xa5[\xa1-\xf3](\xa5[\a1-\xf3]|\xa1\xbc)*//;return ($&, $origkey, 0) if $origkey =~ s/^\xa4[\xa1-\xf3](\xa4[\a1-\xf3]|\xa1\xbc)*//;
return ($origkey, '', 0);}
sub wsearch{local($word)=@_;local(%score);my($hashp, $match, $name, $hit, @word);while ($word ne ''){%score=();($match, $word, $hit)=&binsearch($word, *score);$score{'Disable'}=($match =~ /^\xa4[\xa1-\xf3](\xa4[\a1-\xf3]|\xa1\xbc)*$/) if !$hit;$Hit{$match}=$hit;push(@Words, $match);$hashp=&makehash;%$hashp=%score;push(@ScorePtr, $hashp);push(@word, $match);}return '{ ' . join(' ', @word) . ' }' if $#word > 0;
join(' ', @word);}
sub searchwords{local(@list)=@_;local($_);my($op)='(and|or|not|\&\&|[&|!.])';local(*pair);my(@tmp, @p, $p, $q);foreach $_ (@list){$SubQueryWords=scalar(@Words) if /^\&\&$/;$_=&wsearch($_) if !/^(and|or|not|\&\&|[(){}&|!.\"])$/;}$pair{'('}=')';$pair{'{'}='}';$pair{'"'}='"';for (@list){if (/^[\(\{]/ || ($_ eq '"' && !$q)){unshift(@p, $_);$q=1, $_='{' if $_ eq '"';push(@tmp, $_);}elsif (/^[\}\)]/ || ($_ eq '"' && $q)){while (@p){$p=$pair{shift(@p)};if ($p eq '"'){$q=0;push(@tmp, '}');}else{push(@tmp, $p);}last if $_ eq $p;}}else{push(@tmp, $_);}}while (@p){$p=$pair{shift(@p)};$p='}' if $p eq '"';push(@tmp, $p);}@tmp=&reducep(@tmp);$_=' ' . join(' ', @tmp) . ' ';while ( s/ $op $op / $2 / || s/ $op $/ / || s/ $op ([\}\)]) / $1 / || s/^ $op / / || s/ ([\(\{]) $op / $1 / ){;}s/^\s+//;s/\s+$//;s/\s+/ /g;$_;}
sub reducep{local(@tmp)=@_;if ($tmp[0] eq '(' and $tmp[$#tmp] eq ')'){
my($ndx, $cnt)=(0, 0);for ($ndx = 1; $ndx < $#tmp; $ndx++){
if ($tmp[$ndx] eq '('){++$cnt;}elsif ($tmp[$ndx] eq ')'){last if --$cnt < 0;}}pop(@tmp), shift(@tmp) if !$cnt;}@tmp;}
$hashop::HashName='hash0';
sub makehash{local($_)=@_;++$hashop::HashName;%$hashop::HashName=();return \%$hashop::HashName;}
sub op_score{my($x, $y, $or)=@_;return $y unless $x;return $x unless $y;return $y if $x == -1;return $x if $y == -1;return $x if ($x <=> $y) == $or;$y;}
sub opAnd{local(*X, *Y)=@_;local(*Z, $key, $vx, $vy);return if $Y{'Disable'};%X=%Y, return if $X{'Disable'};$Z{'field_l'}=1 if $X{'field_l'} || $Y{'field_l'};$Z{'field_r'}=1 if $X{'field_r'} || $Y{'field_r'};my($f)=($Z{'field_l'} && $Z{'field_r'});while (($key, $vx)=each(%X)){next if $key =~ /phrase/;next if $key =~ /field_/;if ($vy=$Y{$key}){$Z{$key}=&op_score($vx, $vy);$Z{'phrase'}{$key}=$X{'phrase'}{$key} . $Y{'phrase'}{$key} unless $f;}}%X=%Z;}
sub opPhrase{local(*X, *Y)=@_;local(*Z, $key, $vx, $vy);my($px, $px1, $px2);my($py, $py1, $py2);my($s, $f);return if $Y{'Disable'};%X=%Y, return if $X{'Disable'};$Z{'field_l'}=1 if $X{'field_l'};$Z{'field_r'}=1 if $Y{'field_r'};$f=($Z{'field_l'} && $Z{'field_r'});while (($key, $vx)=each(%X)){next if $key =~ /phrase/;next if $key =~ /field_/;if ($vy=$Y{$key}){if ($X{'field_r'} || $Y{'field_l'}){$Z{'phrase'}{$key} .= $X{'phrase'} if !$X{'field_l'};$Z{'phrase'}{$key} .= $Y{'phrase'} if !$Y{'field_r'};$Z{$key}=&op_score($vx, $vy);next;}for $px (split("\n", $X{'phrase'}{$key})){($px1, $px2)=split(' ', $px);for $py (split("\n", $Y{'phrase'}{$key})){($py1, $py2)=split(' ', $py);$s=$px2 . $py1;&PhraseList($s) if !$Phrase{$s};if ($Phrase{$s}{$key}){$Z{'phrase'}{$key} .= "$px1 $py2\n" unless $f;$Z{$key}=&op_score($vx, $vy);}}}}}%X=%Z;}
sub opNot{local(*X, *Y)=@_;local(*Z, $key, $vx);return if $X{'Disable'};$Z{'field_l'}=1 if $X{'field_l'};$Z{'field_r'}=1 if $X{'field_r'};while (($key, $vx)=each(%X)){next if $key =~ /phrase/;next if $key =~ /field_/;if (!$Y{$key}){$Z{$key}=$vx;$Z{'phrase'}{$key}=$X{'phrase'}{$key};}}%X=%Z;}
sub opOr{local(*X, *Y)=@_;local($key, $vx, $vy, $f);return if $Y{'Disable'};%X=%Y, return if $X{'Disable'};$X{'field_l'}=1 if $X{'field_l'} || $Y{'field_l'};$X{'field_r'}=1 if $X{'field_r'} || $Y{'field_r'};delete $X{'phrase'} if $f=($X{'field_l'} && $X{'field_r'});while (($key, $vy)=each(%Y)){next if $key =~ /phrase/;next if $key =~ /field_/;$X{$key}=&op_score($vx, $vy, 1);$X{'phrase'}{$key}=$X{'phrase'}{$key} . $Y{'phrase'}{$key} unless $f;}}
sub prelist{local($n, @list)=@_;$n = $#list - $n;
pop(@list) while $n-- >= 0;@list;}
sub sublist{local($l, $r, @list)=@_;&postlist($l, &prelist($r, @list));}
sub postlist{local($n, @list)=@_;shift(@list) while $n-- >= 0;@list;}
sub searchp{local($p, *list)=@_;my($l, $r);my($lp, $rp);if ($p){$lp='[\{\(]';$rp='[\}\)]';}else{$lp='[\(]';$rp='[\)]';}for ($r = 0; $r <= $#list; $r++){
if ($list[$r] =~ /^$rp$/){for ($l=$r - 1; $l >= 0; $l--){if ($list[$l] =~ /^$lp$/){return ($l, $r, $list[$l]);}}}}return ();}
sub calc_sub{local($p, @list)=@_;local(@olist)=();local($a, $b, $c);local(*X, *Y);while ($a=shift(@list)){while (ref($a)){if (!defined($b=shift(@list))){push(@olist, $a);last;}elsif (ref($b)){%X=%$a;%Y=%$b;$p? &opPhrase(*X, *Y): &opAnd(*X, *Y);%$a=%X;next;}elsif ($b eq 'or'){push(@olist, $a);last;}elsif ($b =~ /^(and|not)$/){if ($p){push(@olist, $a);}else{$c=shift(@list);%X=%$a;%Y=%$c;($b eq 'not')? &opNot(*X, *Y): &opAnd(*X, *Y);%$a=%X;next;}}}}@olist;}
sub calcp{local($p, @list)=@_;local($a, $b);local(*X, *Y);@list=&calc_sub(($p eq '{' && $DbSize{'PHRASE'}), @list);$a=shift(@list);%X=%$a;while ($b=shift(@list)){%Y=%$b;&opOr(*X, *Y);}%$a=%X;return $a;}
sub operate_proc{local($mode, $calc, @list)=@_;while (($l, $r, $p)=&searchp($mode, *list)){@list=(&prelist($l, @list), &$calc($p, &sublist($l, $r, @list)), &postlist($r, @list));}&$calc('(', @list);}
sub operate{local(@arg)=@_;my($l, $r, @list);foreach $_ (@arg){if (/^(not|\!)$/){push(@list, 'not');}elsif (/^(or|\|)$/){push(@list, 'or');}elsif (/^(and|\&|\&\&)$/){push(@list, 'and');}elsif (/^[\(\)\{\}]$/){push(@list, $_);}else{push(@list, shift(@ScorePtr));}}&operate_proc(1, \&calcp, @list);}
sub lang{for ('LC_TYPE', 'LANG'){return 'Shift_JIS' if $ENV{$_} =~ /sj|shift/i;return 'EUC-JP' if $ENV{$_} =~ /euc/i;}return 'ISO-2022-JP';}
$LANGUAGE=&lang;
$Shift_JIS=(&lang eq 'Shift_JIS');
sub euc::stoe{my($c1, $c2)=@_;$c1=ord($c1);$c2=ord($c2);$c1 += ($c1 - 0x60) & 0x7f;if ($c2 < 0x9f){$c1--;$c2 += ($c2 < 0x7f) + 0x60;}else{$c2 += 2;}chr($c1) . chr($c2);}
sub euc::ktoe{my($c1, $c2)=@_;@euc::ktoe=(0xA3, 0xD6, 0xD7, 0xA2, 0xA6, 0xF2, 0xA1, 0xA3,0xA5, 0xA7, 0xA9, 0xE3, 0xE5, 0xE7, 0xC3, 0xBC,0xA2, 0xA4, 0xA6, 0xA8, 0xAA, 0xAB, 0xAD, 0xAF,0xB1, 0xB3, 0xB5, 0xB7, 0xB9, 0xBB, 0xBD, 0xBF,0xC1, 0xC4, 0xC6, 0xC8, 0xCA, 0xCB, 0xCC, 0xCD,0xCE, 0xCF, 0xD2, 0xD5, 0xD8, 0xDB, 0xDE, 0xDF,0xE0, 0xE1, 0xE2, 0xE4, 0xE6, 0xE8, 0xE9, 0xEA,0xEB, 0xEC, 0xED, 0xEF, 0xF3, 0xAB, 0xAC, ) if !@euc::ktoe;$c1=ord($c1) & 0x7f;my($hi)=($c1 <= 0x25 || $c1 == 0x30 || 0x5e <= $c1)? "\xa1": "\xa5";$c1 -= 0x21;my($lo)=$euc::ktoe[$c1];if ($c2){if ($c1 == 5){$lo=0xdd;}else{$lo++;$lo++ if ord($c2) & 0x7f == 0x5f;}}$hi . chr($lo);}
sub euc::_k2e_{local($_)=@_;s/(.)([\x5e\x5f]?)/&euc::ktoe($1, $2)/ge;$_;}
sub euc::SJtoEUC{$_[0] =~ s/([\x81-\x9f\xe0-\xfa])(.)|([\xa1-\xdf])([\xde\xdf]?)/($3? &euc::ktoe($3, $4): &euc::stoe($1, $2))/ge;}
sub euc::EUCtoEUC{$_[0] =~ s/\x8e(.)(\x8e(.))?/&euc::ktoe($1, $3)/ge;}
sub euc::base64w{local $_=$_[0];my($Len, @Ord);  tr/A-Za-z0-9\+\/\=/\x00-\x3f/d;$Len=scalar(@Ord=unpack('c*', $_)) - 1;substr pack('N',
(($Ord[0] << 6 | $Ord[1]) << 6 | $Ord[2]) << 6 | $Ord[3] ), 1, $Len;}
sub euc::base64{local($_)=@_;my($ret);$ret .= &euc::base64w($&) while s/^....//;$ret;}
sub euc::quoted{local($_)=@_;my($ret);while (!/^$/){$ret .= ' ', next if s/^_//;$ret .= chr(hex($1)), next if s/^=([a-zA-Z0-9]{2})//;$ret .= $& if s/^.//;}$ret;}
sub toEuc{local($_)=@_;my($tmp, $ret);if (s/=\?ISO-2022-JP\?B\?(([a-zA-Z0-9\+\/\=]{4})+?)\?=/&euc::base64($1)/eg | s/=\?ISO-2022-JP\?Q\?((=[0-9a-fA-F][0-9a-fA-F]|[_\x21-\x3c\x3e\x40-\x7e])+)\?=/&euc::quoted($1)/eg | s/\e([\$\(])(.)([\x21-\x7e]*)/(($1 eq "\$")? (($tmp=$3) =~ tr\/\x21-\x7e\/\xa1-\xfe\/,$tmp): (($2 eq "I")? &euc::_k2e_($3): $3) )/ge ){return $_;}elsif (/([\x81-\x8d\x8f-\x9f]|\x8e[^\xa1-\xdf])|([\xfd\xfe]|[^\x81-\x9f\xb6-\xc4\xca-\xce\xe0-\xfa][\xde\xdf]|[\xb6-\xc4]\xde)/){if ($Shift_JIS=$1){&euc::SJtoEUC($_);}else{&euc::EUCtoEUC($_);}return $_;}else{while(!/^$/){if (s/^[\x00-\x80\xa0\xff]+//){($tmp=$&) =~ tr/\x80\xa0\xff//d;$ret .= $tmp;}elsif (/^([\xaf\xf6\xf7])|^(\xea[\xa3-\xfe]|[\xeb\xef-\xfe][\xa1-\xfe])/){if ($Shift_JIS=$1){&euc::SJtoEUC($_);}else{&euc::EUCtoEUC($_);}last;}elsif ($Shift_JIS){s/^([\x81-\x9f\xe0-\xfa])(.)|([\xa1-\xdf])([\xde\xdf]?)//;if ($3){$ret .= &euc::ktoe($3, $4);}else{$ret .= &euc::stoe($1, $2);}}elsif (s/^\x8e(.)(\x8e([\xde\xdf]))?//){$ret .= &euc::ktoe($1, $3);
}else{s/^..?//;$ret .= $&;}}return $ret . $_;}}
sub pnkfz1{local($f, $_)=@_;if ($f eq "\xa1"){return $_ if tr/\xa1\xa4\xa5\xa7\xa8\xa9\xaa\xae\xb0\xb2\xbf\xc3\xc7\xc9\xca\xcb\xd0\xd1\xdc\xdd\xe1\xe3\xe4\xf0\xf3\xf4\xf5\xf6\xf7/ ,.:;?!`^_\/|'"(){}+\-=<>$%#&*@/; #`
}elsif ($f eq "\xa3"){return $_ if tr/\xc1-\xda\xe1-\xfa\xb0-\xb9/A-Za-z0-9/;}$f . $_;}
sub input::pWakachi{local($_)=@_;my($ret);s/([\x21-\x7f])([\x80-\xff])/$1 $2/g;s/([\x80-\xff])([\x21-\x7f])/$1 $2/g;return $_;while (!/^$/){$ret .= $&, next if s/^[^\xa1-\xfe]+//;if (/^\xa4[\xa1-\xf3]/){s/^(\xa4[\a1-\xf3]|\xa1\xbc)+//;$ret .= $&;$ret .= $& if s/^\*//;$ret .= ' ' if /^\S/;next;}if (/^\xa5[\xa1-\xf6]/){s/^(\xa5[\a1-\xf6]|\xa1\xbc)+//;$ret .= $&;$ret .= $& if s/^\*//;$ret .= ' ' if /^\S/;next;}if (s/^([\xa1-\xfe][\xa1-\xfe])+?(\xa5[\xa1-\xf6])//){my($tmp)=$&;$_=$2 . $_;$tmp =~ s/..$/ /;$ret .= $tmp;next;}s/^[\xa1-\xfe]+//;$ret .= $&;}$ret .= $_;}
sub string_normalize{local($_)=@_;my($f, $b, $pat);$_=&toEuc($_);s/([\x80-\xff])(.)/&pnkfz1($1, $2)/ge;s/^\s+//;while (!/^$/){if (s/^(\+[^\s\:]+\:)?\///){my($tmp)=$&;$tmp =~ tr/A-Z/a-z/;$pat .= $tmp;$tmp='';while (!(/^\s*$/ || s/^\/\s+// || s/^\/$//)){$tmp .= $&, next if s/^[^\\\/]+//;$tmp .= $&, next if s/^\///;$tmp .= $&, next if s/^\\.//;$tmp .= $&, next if s/^\\$//;}$tmp =~ s/\s/\\s/g;$pat .= "$tmp/ ";next;}$pat .= "$1 ", next if s/^([\"\{])\s*//;$pat .= "$1 ", next if s/^(\+[^\s\:]+\:\S+)\s*//;if (s/^(\S+)\s*//){my($tmp)=$1;my($p)=($tmp =~ s/[\"\}]$//)? " $&": '';my($f)=($tmp =~ s/\*$//)? $&: '';my($b)=($tmp =~ s/^\*//)? $&: '';($tmp=&input::pWakachi($tmp)) =~ tr/A-Z/a-z/;$pat .= $b . &input::pWakachi($tmp) . $f . $p . " ";}}$_=$pat;s/\s+/ /g;s/^\s+//;s/\s+$//;$_;}
$output::Lang=&lang;
sub output::tosjis{my($c1, $c2)=unpack('CC', shift);$c2 -= ($c1 & 1)? (0x60 + ($c2 < 0xe0)): 2;$c1=($c1 + 0x61) >> 1;$c1 += 0x40 if $c1 >= 0xa0;pack('CC', $c1, $c2);}
sub output{my(@list)=@_;my($tmp);foreach $_ (@list){$_=&html2plain($_) if $PlainConv;if ($output::Lang eq 'ISO-2022-JP'){s/[\x80-\xff]+/\e\$B$&\e\(B/g;tr/\x80-\xff/\x00-\x7f/;}else{s/\e\$[\@B](.*?)\e\([BJ]/($tmp=$1,$tmp =~ tr\/\x21-\x7e\/\xa1-\xfe\/,$tmp)/ge;s/[\x80-\xff]./&output::tosjis($&)/ge if $output::Lang eq 'Shift_JIS';}print;}}
sub message{local($_)=@_;$_=&html2plain($_) if $PlainConv;if ($output::Lang eq 'ISO-2022-JP'){s/[\x80-\xff]+/\e\$B$&\e\(B/g;tr/\x80-\xff/\x00-\x7f/;}print;}
sub opentfile{local(*fH, $filename)=@_;local($_);my($dev,$ino,$mode,$nlink,$uid,$gid,$rdev,$size,$atime,$mtime);if (!$LANGUAGE || $LANGUAGE =~ /ja|jp|jis/i){$_="$filename.ja";}elsif (! -r ($_="$filename.$LANGUAGE")){$_=$filename . '-e';}-r $_ || -r ($_=$filename) || chop($_);($dev,$ino,$mode,$nlink,$uid,$gid,$rdev,$size,$atime,$mtime)=stat($_) if open(fH, $_);$mtime;}
sub db::openzfile{local(*fH, $filename)=@_;if (-r $filename){if ($ZcatPri){$ZCatPri=0;eval{setpriority(0, 0, $IniPri + $ZcatPri)};}return open(fH, "$Zcat $filename |");}return 0;}
sub openbfile_opt{local($str, $filename, $die)=@_;local(*fH)=$str;my($tmp)=$/;my($dev,$ino,$mode,$nlink,$uid,$gid,$rdev,$size,$atime,$mtime);if ($Zcat){my($fname);if (&db::openzfile(*fH, ($fname="$filename.gz")) || &db::openzfile(*fH, ($fname="$filename"."z"))){binmode(fH);undef $/;$fH=<fH>;$/=$tmp;close(fH);if (!$?){($dev,$ino,$mode,$nlink,$uid,$gid,$rdev,$size,$atime,$mtime)=stat($fname);$DbSize{$str}=$size=length($fH);$DbNdx{$str}=$size / $IntSize if $IntSize;return $mtime;}$fH='';}}if (open(fH, $filename)){binmode(fH);($dev,$ino,$mode,$nlink,$uid,$gid,$rdev,$size,$atime,$mtime)=stat(fH);$DbSize{$str}=$size;$DbNdx{$str}=$size / $IntSize if $IntSize;return $mtime;}elsif ($die){die $filename;}return 0;}
sub openbfile{&openbfile_opt($_[0], $_[1], 1);}
sub openfiles{my($dbname)=@_;@HEAD=<HEAD> if &opentfile(*HEAD, "$dbname.head");@FOOT=<FOOT> if &opentfile(*FOOT, "$dbname.foot");}
sub opendb{my($dbname)=@_;my(@tmp);my($sec,$min,$hour,$mday,$mon,$year,$wday);$dbname=$DbPath if !$dbname;if (-e "$dbname.lock"){&puthtmlheader;if (&opentfile(*MSG, "$dbname.msg")){print while <MSG>;}else{print "(now be in system maintenance)\n";}exit;}$HashTime=&openbfile('HASH', "$dbname.h");($sec,$min,$hour,$mday,$mon,$year,$wday)=gmtime($HashTime);$LastModified=sprintf("%s, %02d %s %04d %02d:%02d:%02d GMT",('Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat')[$wday],$mday,('Jan', 'Feb', 'Mar', 'Apl', 'May', 'Jun','Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec')[$mon],$year + 1900, $hour, $min, $sec);&openbfile('INDEX', "$dbname.i");&openbfile('INDEXINDEX', "$dbname.ii");&openbfile("FLIST_____$DbList", "$dbname.f");&openbfile("FLISTINDEX$DbList", "$dbname.fi");&openbfile_opt('PHRASE', "$dbname.p");&openbfile_opt('PHRASEINDEX', "$dbname.pi");&openbfile_opt('TIM', "$dbname.t");}
sub closefile{local($str)=@_;local(*fH)=$str;close(fH);undef $fH;delete $DbNdx{$str};delete $DbSize{$str};}
sub closedb{my($dbname)=@_;undef $HashTime;&closefile('HASH');&closefile('INDEX');&closefile('INDEXINDEX');&closefile('TIM');&closefile('PHRASE');&closefile('PHRASEINDEX');&bwclose;&w_init;&phrase_init;undef %db::cache_rii_buf;undef @Words;undef %Hit;undef %SubHit;undef @ScorePtr;undef @DbErrors;}
sub dbsize{local(*fH)=@_;my($dev,$ino,$mode,$nlink,$uid,$gid,$rdev,$size);return length($fH) if $fH;($dev,$ino,$mode,$nlink,$uid,$gid,$rdev,$size)=stat(fH);$size;}
sub Burst_on{local(*fH, $offset)=@_;$db::Burst=1;seek(fH, $offset, 0) if !$fH;}
sub Burst_off{$db::Burst=0;}
sub readdb{local(*fH, $offset, $size)=@_;my($buf, $len);if ($fH){return ($offset, -1) if $offset >= length($fH);$buf=substr($fH, $offset, $size);}else{seek(fH, $offset, 0) if !$db::Burst;return ($offset, -1) if eof(fH);read(fH, $buf, $size);}$offset += $size;($offset, $buf);}
sub getsdb{local(*fH, $offset, $size)=@_;my($buf, $len);if ($fH){while ($offset < length($fH)){$c=substr($fH, $offset++, 1);last if $c =~ /^$/;$buf .= $c;}}else{seek(fH, $offset, 0) if !$db::Burst;$buf=<fH>;$offset += length($buf);chomp($buf);}($offset, $buf);}
sub indexpointer{local(*fH, $n)=@_;my($val);$n *= $IntSize;$val=&readdb(*fH, $n, $IntSize);unpack($IntType, $val);}
sub readindexindex{my($x)=@_;my($offset, $buf);return ($offset, $db::cache_rii_buf{$x}) if ($offset=$db::cache_rii_off{$x});($offset, $buf)=&getsdb(*INDEX, &indexpointer(*INDEXINDEX, $x));($db::cache_rii_off{$x}=$offset, $db::cache_rii_buf{$x}=$buf);}
sub readindexscore{local($n, *score, $str)=@_;my($filescore, $fileno, $p, $hit, $net, $ret);local(*tmpscore);($p, $str)=&readindexindex($n);&Burst_on(*INDEX, $p);($p, $hit)=&readdb(*INDEX, $p, $IntSize);$hit=unpack($IntType, $hit) / 2;while ($hit-- > 0){($p, $fileno)=&readdb(*INDEX, $p, $IntSize);$fileno=unpack($IntType, $fileno);($p, $filescore)=&readdb(*INDEX, $p, $IntSize);$filescore=unpack($IntType, $filescore);$tmpscore{$fileno}=$filescore;}&Burst_off;for $fileno (sort {$a <=> $b} keys(%tmpscore)){if (&TimEnable($fileno)){$filescore=$tmpscore{$fileno};$score{'phrase'}{$fileno} .= "$str $str\n";$net++;$ret++ if !$score{$fileno};$score{$fileno}=$filescore if $filescore > $score{$fileno};}}($net, $ret);}
sub lastNdx{my($fh, $x)=@_;my($fhi)=$fh . 'INDEX';($x < $DbNdx{$fhi})? &indexpointer($fhi, $x): $DbNdx{$fh};}
sub lastSize{my($fh, $x, $db)=@_;my($fhi)=$fh . 'INDEX';$fhi=$db if $db;($x < $DbNdx{$fhi})? &indexpointer($fhi, $x): $DbSize{$fh};}
sub TimEnable{local($fileno)=@_;my $p=$fileno;$p .= "#$DbList" if $DbList;
unless (defined($Tim{$p})){if ($fileno < $DbNdx{'TIM'}){$Tim{$p}=&indexpointer('TIM', $fileno);}else{$Tim{$p}=$fileno;}}$Tim{$p} != $IntFF;}
sub load_namazu_conf{my($env, $conf);if (($env=$ENV{'NAMAZUCONFPATH'}) && open(FH, $conf=$env) or ($env=$ENV{'NAMAZUCONF'}) && open(FH, $conf=$env) or (open(FH, $conf='.namazurc') || open(FH, $conf='namazu.conf')) or $ScriptDir && (open(FH, $conf="$ScriptDir/.namazurc") || open(FH, $conf="$ScriptDir/namazu.conf")) or ($env=$ENV{'HOME'}) && (open(FH, $conf="$env/.namazurc") || open(FH, $conf="$env/namazu.conf")) or ($NamazuConf && open(FH, $conf=$NamazuConf)) or $NamazuDir and (open(FH, $conf="$NamazuDir/namazu.conf") || open(FH, $conf="$NamazuDir/lib/namazu.conf")) ){$NamazuConf=$conf;while(<FH>){next if /^# /;
$DEFAULT_DIR=$2 if /^(INDEX|DEFAULT_DIR)\s+(\S+)/i;$BASE_URL=$1 if /^BASE_URL\s+(\S+)/i;$URL_REPLACE_FROM=$1, $URL_REPLACE_TO=$2 if /^REPLACE\s+(\S+)\s+(\S+)/i;$URL_REPLACE_FROM=$1 if /^URL_REPLACE_FROM\s+(\S+)/i;$URL_REPLACE_TO=$1 if /^URL_REPLACE_TO\s+(\S+)/i;$WAKATI=$2 if /^(wakachi|wakati)\s+(\S+)/i;$LOGGING=$1 if /^LOGGING\s+(\S+)/i;$LANGUAGE=$1 if /^LANGUAGE\s+(\S+)/i;$SCORING=$1 if /^SCORING\s+(\S+)/i;}$LOGGING=0 if $LOGGING =~ /^off$/i;$LANGUAGE="ja" if($LANGUAGE =~ /JAPANESE/i);$LANGUAGE="en" if($LANGUAGE =~ /ENGLISH/i);$ReplaceFrom=quotemeta($URL_REPLACE_FROM);$ReplaceTo=$URL_REPLACE_TO;close(FH);}}
$BW=1;
sub bwopen{my($fh, $ext)=@_;(&openbfile_opt($fh, "$DbPath.$ext") >= $HashTime && &openbfile_opt($fh . 'INDEX', "$DbPath.$ext" . 'i') >= $HashTime);}
sub bwclose{my($fh, $ext)=@_;&closefile('MB');&closefile('MBINDEX');&closefile('SB');&closefile('SBINDEX');&mb_init;&sb_init;}
sub w_bw{local($origkey, *score, $key, $forward)=@_;my($str)=$key;my($ptr, $tmp, $bstr, $pre, $buf);my($match, $bw);my($x, $totalhit, $len, $max);local(%kdat, %ldat);if ($str =~ s/([\xa1-\xfe])([\xa1-\xfe])/$1 . chr(0x7f & ord($2))/ge){$bw=(length($key) > 2);$ptr=\@WdbM;$x=$WdbX;}else{$ptr=\@WdbS;}$str =~ s/[\x00-\x7f]+/quotemeta($&)/ge;$str .= "\$" if !$forward;for (@$ptr){($buf=$_) =~ s/([\xa1-\xfe])([\xa1-\xfe])/$1 . chr(0x7f & ord($2))/ge;if ($buf =~ /$str/){$match=1;$bw=0;$kdat{$x}=1;}if ($bw){$tmp=$key;while ($tmp =~ s/..$// && $tmp){$len=length($tmp);if (/$tmp$/){if ($len > $max){$bstr=$tmp;$max=$len;%ldat=();}$ldat{$x}=1;}last if $len eq $max;}}$x++;}if ($match){$pre=$origkey;$key='';}elsif (%ldat){%kdat=%ldat;$str="$bstr\$";($key=$origkey) =~ s/^\*$bstr//;$pre=$&;}elsif ($origkey =~ s/^\*\xa4[\xa1-\xf3](\xa4[\a1-\xf3]|\xa1\xbc)*//){return ($&, $origkey, 0);}else{return ($origkey, '', 0);}foreach $x (sort {$a <=> $b} keys(%kdat)){&ssub(\$totalhit, *score, $pre, $str, $x, $match);}
return ($pre, $key, $totalhit);}
sub bwsearch{local($origkey, *score, $key, $forward, $fh)=@_;local(%kdat, %ktmp);local(%ldat, %ltmp);my($str, $ini)=($key, 1);my($x, $l, $r, $buf, $totalhit);my($bstr, $pre, $match, $h, $c1, $c2);my($indexsub, $fhi, $charsub);my($bw)=($fh eq 'MB');$indexsub=\&mbindex, $charsub=\&mbchars if $fh eq 'MB';$indexsub=\&sbindex, $charsub=\&sbchars if $fh eq 'SB';$fhi=$fh . 'INDEX';$str =~ s/[\x00-\x7f]+/quotemeta($&)/ge;$str .= "\$" if !$forward;$key =~ s/[^a-zA-Z0-9\x80-\xff]/_/g;while (($c1, $c2)=&$charsub($key)){$pre .= "$c1$c2";$x=&$indexsub($c1, $c2);$l=&indexpointer($fhi, $x++);$r=&lastNdx($fh, $x);%ktmp=%kdat, %kdat=();%ltmp=%ldat, %ldat=() if $bw;while ($l < $r){$x=&indexpointer($fh, $l++);if ($ini || $ktmp{$x}){$kdat{$x}=1;if ($bw){$buf=&readindexindex($x);$bw=0, next if $ini && ($buf =~ /$str/);$bstr=$pre, $ldat{$x}=1 if $buf =~ /$pre$/;}}}$match=!$bw, $ini=0 if $ini;%ldat=%ltmp if $bw && !%ldat;last if !%kdat;}if ($match){$pre=$origkey;$key='';}elsif (%ldat){%kdat=%ldat;$str="$bstr\$";
($key=$origkey) =~ s/^\*$bstr//;$pre=$&;}elsif ($origkey =~ s/^\*\xa4[\xa1-\xf3](\xa4[\a1-\xf3]|\xa1\xbc)*//){return ($&, $origkey, 0);}else{return ($origkey, '', 0);}foreach $x (sort {$a <=> $b} keys(%kdat)){&ssub(\$totalhit, *score, $pre, $str, $x);}return ($pre, $key, $totalhit);}
sub mb_init{$Mb=-1;$MbByteL=0xa1;$MbByteR=0xfe;$MbWordL=($MbByteL * 0x100 + $MbByteL);$MbWordR=($MbByteR * 0x100 + $MbByteR);$MbElem=$MbByteR + 1 - $MbByteL;}
&mb_init;
sub mb_ndx{local($_)=@_;return ord($_) - 0xa1;}
sub mbindex{return &mb_ndx($_[0]) * $MbElem + &mb_ndx($_[1]);}
sub mbchars{return ($_[0] =~ s/^(.)(.)//)? ($1, $2): ();}
sub sb_init{$Sb=-1;$SbByteL=0x21;$SbByteR=0x7e;$SbWordL=($SbByteL * 0x100 + $SbByteL);$SbWordR=($SbByteR * 0x100 + $SbByteR);$SbOffsetA=1;$SbOffsetN=$SbOffsetA + (ord('z') - ord('a') + 1);$SbElem=$SbOffsetN + (ord('9') - ord('0') + 1);$SbOffsetA -= ord('a');$SbOffsetN -= ord('0');}
&sb_init;
sub sb_ndx{local($_)=@_;my($ord)=ord($_);return $ord + $SbOffsetA if /^[a-z]/;return $ord + $SbOffsetN if /^[0-9]/;return 0;}
sub sbindex{return &sb_ndx($_[0]) * $SbElem + &sb_ndx($_[1]);}
sub sbchars{return ($_[0] =~ s/^(.)(.)/$2/)? ($1, $2) : ();}
sub phrase_init{undef %Phrase;}
sub PhraseList{my($s)=@_;my($x)=&hash($s);my($l, $n, @ret, $tmp);if (($l=&indexpointer(*PHRASEINDEX, $x)) != 0xffffffff){$l /= 4;$n=&indexpointer(*PHRASE, $l++);while ($n--){$x=&indexpointer(*PHRASE, $l++);$Phrase{$s}{$x}=1;}}$Phrase{$s}{'enable'}=1;}
sub hash () {local($_)=@_;my ($hash, $i);while (m/[\xa1-\xfea-z0-0]/g){$hash ^= $Seed[($i++) & 3][ord($&)];}$hash & 65535;}
&init_seed;
sub init_seed () {@Seed= ( [ 3852, 26205, 51350, 2876, 47217, 47194, 55549, 43312,  63689, 40984, 62703, 10954, 13108, 60460, 41680, 32277,  51887, 28590, 17502, 57168, 37798, 27466, 13800, 12816,  53745, 8833, 55089, 15481, 18993, 15262, 8490, 22846,  41468, 59841, 25722, 23150, 41499, 15735, 926, 39653,  56720, 63629, 50607, 4292, 58554, 26752, 36570, 44905,  55343, 54073, 36538, 27605, 16003, 50339, 40422, 4213,  59172, 29975, 19694, 12629, 45238, 28185, 35475, 21170,  22491, 61198, 44320, 63991, 11398, 45247, 38108, 2583,  43341, 23180, 6875, 36359, 49933, 43446, 15728, 39740,  31983, 52267, 1809, 47986, 37070, 42232, 52199, 30706,  6672, 6358, 43336, 51910, 34544, 13276, 7545, 57036,  8939, 51866, 55491, 20338, 31577, 28064, 22921, 9383,  51245, 29797, 45742, 35642, 7707, 61471, 9847, 39691,  48202, 11656, 22141, 19736, 53889, 8805, 50443, 60561,  15164, 28244, 46936, 49709, 41521, 54481, 41209, 50460,  40812, 31165, 5262, 6853, 59230, 28184, 16237, 44940, 
57981, 61979, 15046, 152, 57914, 24893, 39843, 40581,  36550, 61985, 60318, 24904, 5255, 45226, 19929, 20420,  7934, 1329, 4593, 49456, 55811, 45803, 34381, 31087,  11433, 39644, 37941, 5128, 2292, 54178, 50068, 60273,  50622, 65115, 60426, 43000, 24473, 34734, 18046, 61024,  31184, 12828, 20392, 36439, 58054, 40322, 56860, 453,  41651, 61453, 49909, 31927, 41721, 18754, 63015, 53155,  58398, 35421, 58283, 60691, 24063, 42816, 55428, 9149,  42395, 50319, 52150, 1332, 19517, 4661, 62357, 50701,  17489, 17213, 21605, 10008, 57535, 12929, 10462, 33651,  8847, 60371, 43, 50569, 13590, 63058, 38188, 6453,  32943, 30936, 1608, 57007, 8216, 57037, 621, 50611,  41820, 52771, 51944, 61338, 57433, 48765, 46504, 9387,  443, 2573, 19395, 57978, 15503, 29857, 26094, 24351,  24693, 26137, 9385, 38284, 23659, 47573, 44738, 56602 ],[ 12974, 46347, 48074, 21190, 37848, 48695, 6266, 14133,  35931, 58211, 9935, 27828, 41440, 56440, 37215, 41883,  59014, 56610, 34326, 8982, 20932, 60420, 33333, 45626, 
21021, 42718, 18375, 44681, 24756, 63113, 35748, 37730,  43924, 18286, 58920, 1445, 65187, 30371, 37376, 57862,  40307, 65205, 33766, 31211, 36884, 10114, 24689, 27959,  44441, 33671, 48892, 39326, 1469, 28982, 60348, 44188,  47357, 39493, 3408, 44935, 9705, 41138, 23324, 27992,  34523, 39562, 29437, 34174, 4397, 1278, 26500, 44705,  947, 60267, 10380, 37832, 4846, 35070, 255, 49288,  3206, 49147, 23078, 4676, 12594, 17890, 48864, 59951,  57383, 52273, 39351, 1553, 27875, 62675, 29545, 62399,  36701, 58983, 31038, 41099, 60262, 57539, 20268, 61210,  52271, 30649, 33506, 57118, 184, 33762, 40870, 3390,  17374, 63949, 8067, 29968, 16303, 56931, 24384, 8151,  43668, 63736, 6008, 60875, 39251, 2872, 32040, 32699,  33910, 7603, 27426, 25914, 27872, 23100, 12649, 58521,  56607, 4231, 58705, 24834, 45102, 62096, 42208, 43515,  4627, 6641, 59819, 61559, 31026, 2435, 39692, 29226,  12141, 45700, 24565, 51392, 48573, 56606, 18556, 16947,  64210, 45982, 42861, 26546, 3546, 55511, 19531, 60154, 
59743, 12700, 19452, 39309, 9261, 61660, 17289, 13888,  2766, 11572, 9912, 33792, 14008, 49604, 63018, 26149,  29769, 22048, 12006, 12806, 13118, 30562, 29754, 11792,  11008, 7080, 38339, 14554, 62591, 57870, 9172, 56798,  5035, 28625, 30572, 14297, 24749, 47861, 27515, 59433,  38098, 61308, 7906, 22166, 58790, 34055, 51935, 15303,  46061, 64742, 28421, 11087, 28960, 40214, 22095, 36041,  13018, 36650, 33096, 5352, 45823, 24359, 10388, 8912,  54931, 24685, 33662, 37257, 52871, 61178, 31155, 25433,  56950, 39061, 47599, 50204, 7580, 33999, 65507, 53642,  33205, 28393, 64730, 62166, 3072, 21290, 32671, 16090 ],[ 57940, 232, 21443, 38228, 24592, 31831, 47141, 13988,  56517, 15268, 43852, 10910, 16864, 3750, 2324, 55926,  52529, 63507, 19813, 52501, 51613, 53019, 15359, 50807,  49650, 18431, 6561, 16785, 34522, 64502, 17018, 55965,  37195, 41610, 22261, 18801, 55598, 13243, 34069, 41307,  57095, 44979, 58172, 60846, 47304, 48562, 46660, 34298,  46533, 938, 21264, 32611, 53957, 36623, 17883, 38072, 
55055, 24444, 54857, 24042, 23411, 6340, 14471, 60606,  47950, 36733, 13872, 38012, 49976, 47941, 13784, 41536,  27385, 6421, 36846, 9154, 54984, 17971, 43452, 35982,  18909, 64716, 3057, 7331, 35804, 20941, 45403, 25324,  45385, 34725, 49366, 3261, 41065, 63838, 63868, 23479,  35036, 12204, 61492, 19476, 60146, 9741, 61013, 21995,  16163, 32324, 31149, 5612, 50295, 9066, 41594, 3669,  8247, 44652, 11000, 44052, 57, 56404, 3840, 45443,  25593, 53206, 48704, 1123, 51508, 47037, 24603, 21008,  59241, 20559, 40485, 53851, 30301, 35963, 10311, 46465,  2751, 41461, 52077, 53047, 50527, 28135, 56717, 58775,  7252, 2182, 37291, 7309, 58586, 41131, 52753, 18644,  28802, 35922, 19767, 14775, 17423, 44371, 35784, 11128,  64931, 10734, 64980, 29696, 46697, 9756, 10626, 49449,  51217, 36961, 36209, 25303, 28142, 29448, 32555, 30324,  1204, 39865, 23375, 42336, 27082, 42020, 5602, 63004,  61788, 20378, 14892, 40623, 56162, 26021, 40018, 1360,  25466, 4179, 48058, 35222, 14805, 31971, 20903, 11973, 
3396, 57112, 37276, 31539, 21025, 4295, 61864, 22230,  44161, 19704, 64566, 5707, 61724, 4633, 3176, 57977,  25011, 18069, 33064, 15638, 44090, 7547, 16998, 4020,  11727, 65056, 39242, 26532, 31492, 38506, 34888, 51723,  10246, 891, 7213, 14542, 62756, 29443, 58703, 16924,  28473, 64411, 13112, 33107, 2052, 5554, 58118, 20121,  38618, 8220, 64212, 46166, 25219, 2696, 57893, 24740 ],[ 41939, 18890, 56232, 36549, 57396, 25584, 22736, 2106,  26476, 29949, 16648, 23697, 59393, 9816, 40621, 22331,  8691, 53734, 55438, 10743, 59288, 48021, 30865, 32371,  56242, 29541, 13001, 15925, 32237, 5358, 40666, 8641,  24249, 31362, 45191, 16109, 56947, 2391, 18216, 17887,  32341, 34864, 41584, 26199, 44680, 16670, 48530, 53372,  4868, 38432, 64115, 64156, 20918, 29445, 30992, 11624,  58986, 43993, 27550, 25688, 49352, 2680, 34329, 8065,  34042, 13984, 24174, 25454, 16376, 42391, 43342, 48718,  11719, 19390, 9381, 56400, 36061, 57911, 44237, 40929,  30808, 39550, 51726, 6725, 5006, 63351, 176, 49000, 
25365, 25864, 32816, 28046, 60193, 40882, 62089, 8642,  65057, 22007, 25018, 41912, 65349, 8201, 53632, 19204,  17582, 44496, 55265, 9957, 23197, 30659, 40765, 478,  4674, 26956, 7204, 9681, 24771, 7380, 58681, 50137,  33245, 25962, 12647, 27903, 1308, 9200, 36545, 829,  31207, 61564, 42741, 31021, 4229, 30837, 50225, 21812,  9798, 39955, 31769, 32996, 5078, 6999, 33475, 9753,  33956, 40679, 19434, 58727, 48060, 12579, 43328, 15770,  38541, 55975, 43673, 39849, 65176, 14683, 30848, 10711,  17884, 61869, 14941, 48722, 46559, 36753, 58520, 20978,  2987, 25981, 26057, 9987, 59456, 35810, 43943, 34600,  55244, 37135, 17124, 2288, 14928, 32895, 40829, 5368,  11032, 15143, 5008, 25715, 55822, 35856, 36427, 8171,  32190, 51369, 56893, 13214, 22587, 49878, 34193, 25575,  10323, 60250, 35562, 4243, 30525, 13970, 38843, 20234,  51106, 55968, 22523, 498, 23327, 63352, 5866, 34360,  12960, 10874, 60076, 3247, 46731, 30967, 11418, 13386,  16801, 2776, 26600, 39388, 52654, 60793, 64963, 62978, 
55508, 34990, 1686, 20498, 48960, 40530, 40733, 34530,  30962, 63256, 35029, 54290, 61073, 40895, 23115, 8497,  51770, 17655, 11744, 32966, 48622, 23162, 46352, 65423 ] );}
sub w_init{$Wdb=0;@WdbM=();@WdbS=();$WdbX=0;}
&w_init;
sub w_set{local($_)=@_;chomp;s/\s.*//;if (/[\xa1-\xfe]/){s/[\xa1-\xfe]./\xff$&/g;push(@WdbM, $_);}else{++$WdbX;push(@WdbS, $_);}}
sub w_read{my($db)=@_;local(*FW, $_);if (!$Wdb){if (-r $db && open(FW, $db)){&w_set($_) while <FW>;close(FW);}else{my($i, $w);while ($i < $DbNdx{'INDEXINDEX'}){$w=&readindexindex($i++);&w_set($w);}}$Wdb=1;}}
sub cgiparamget{local($val, $key, $_);if ($PathInfo=$ENV{'PATH_INFO'}){($val=$PathInfo) =~ s/^\///;push(@DbList, $val);}$val=$ENV{'QUERY_STRING'};$val=join('', <>) if !$val && $ENV{'REQUEST_METHOD'} =~ /post/i;@OriginalQuery=split(/&/, $val);for (@OriginalQuery){($key, $val)=split(/=/, $_);$val =~ s/\+/ /g;$val =~ s/%([\dA-Fa-f][\dA-Fa-f])/pack("C",hex($1))/eg;$KeyStr=$ARGV=$val if $key =~ /key/i;$Sort=$val if $key =~ /sort/i;$Max=$val if $key =~ /max/i;$Whence=$val if $key =~ /whence/i;@DbList=(@DbList, split(/,/, $val)) if $key =~ /dbname/i && $val !~ /^\// && $val !~ /\.\.\//;$Format=$val if /format/i;$Detail= $val if /detail/i;$Subquery=$val if $key =~ /subquery/i;$Reference=$val if $key =~ /reference/i;}$ARGV =~ s/\s\&\&\s/ \& /g;$Subquery =~ s/\s\&\&\s/ \& /g;$ARGV="( $Subquery ) && ( $ARGV )" if $Subquery;}
sub pre_proc{$ARGV=&string_normalize($ARGV);@ARGV=split(/\s+/, $ARGV);&opendb();&set_inttype;}
sub searchmain{local(*score);my($no, $key);@ARGV=split(/\s+/, ($ARGV=&searchwords(split(/\s+/, $ARGV))));%score=%{&operate(@ARGV)};delete $score{'Disable'};delete $score{'phrase'};delete $score{'field_l'};delete $score{'field_r'};for (keys(%score)){$key=$_;$key .= "#$DbList" if $DbList;
$Score{$key}=$score{$_};}$Keys=scalar(keys(%score));}
sub searchsort{if ($Sort eq 'score'){@Keys=sort {$Score{$b} <=> $Score{$a}} keys(%Score);}elsif ($Sort eq 'earlier'){@Keys=sort {$Tim{$a} <=> $Tim{$b}} keys(%Score);}else{@Keys=sort {$Tim{$b} <=> $Tim{$a}} keys(%Score);}$Keys=scalar(@Keys);}
sub tag_elem{local($_, $key, $val)=@_;if ($val ne ''){s/($key\s*\=\s*\")(.*?)(\")/$1$val$3/i || s/($key\s*\=\s*)(\S*)/$1$val/i || s/\s*\>/ $key=\"$val\"\>/;return $_;}else{$val=$2 if /($key\s*\=\s*\")(.*?)(\")/i || /($key\s*\=\s*)(\S*)/i;return $val;}}
sub tag_sel{local($_, $key, $val)=@_;if ($val){s/\s*\>/ $key\>/ if !/$key/i;}else{s/\s*$key//i;}$_;}
sub headcat{my($name, $form, $val);my($pre, $post);my($tag, $value);my($ptr, $select);my($db);local(%paramtbl)=('max' => \$Max,'sort' => \$Sort,'format' => \$Format,'detail' => \$Detail,'dbname' => \@DbList,'subquery' => \$Subquery,'reference' => \$Reference,);foreach $_ (@HEAD){s/\<title[^\>]*\>/$&pNamazu:$KeyStr \/ /i;if (/\<\/HEAD\>/i){&output("<META HTTP-EQUIV=\"Last-Modified\" CONTENT=\"$LastModified\">\n") if $LastModified;&output("<BASE HREF=\"$BASE_URL\">\n") if $BASE_URL;}$form=1 if /\<FORM/i;if ($PrintForm || !$form){if (/\<\s*(option|select|input|\/select).*?\>/i){$pre=$`;$post=$';$_=$&;($tag=$1) =~ tr/A-Z/a-z/;$name=&tag_elem($_, 'name');$name =~ tr/A-Z/a-z/;$value=&tag_elem($_, 'value');$db=1 if $name eq 'dbname';if ($tag eq 'input'){my($type)=&tag_elem($_, 'type');$type =~ tr/A-Z/a-z/;if ($type eq 'text' && $name eq 'key'){if ($RespTextOrig){$_=&tag_elem($_, 'value', $KeyStr);}else{my $tmp=$ARGV;$tmp =~ s/^.* \&\& //;my @tmp=split(/\s+/, $tmp);if (@tmp=&reducep(@tmp)){
$_=&tag_elem($_, 'value', join(' ', @tmp));}}}elsif ($type eq 'checkbox' && $name eq 'dbname'){$_=&tag_sel($_, 'checked',grep($value eq $_, @DbList));}}elsif ($tag eq 'select'){$ptr=$paramtbl{$name};$select=(ref($ptr) ne 'SCALAR');}elsif ($tag eq '/select'){if (!$select && ($ptr=$$ptr) ne ''){&output("<option value=\"$ptr\" selected>$ptr\n");}}elsif ($tag eq 'option'){my($flag);if (ref($ptr) eq 'ARRAY'){$select=1 if $flag=grep($value eq $_, @$ptr);$_=&tag_sel($_, 'selected', $flag);}elsif (ref($ptr) eq 'SCALAR'){$select=1 if $flag=($$ptr =~ /^$value$/i);$_=&tag_sel($_, 'selected', $flag);}}$_="$pre$_$post";}if ($form && /\<\/FORM\>/i && !$db){for $db (@DbList){&output("<input type=\"hidden\" name=\"dbname\" value=\"$db\">\n");}}&output($_);}$form=0 if /\<\/FORM\>/i;}}
sub putsubmes{&message("<H2>$MesResults:</H2>\n");if (@DbErrors){&message("Errors:\n");for (@DbErrors){&message("$_<BR>\n");}}&message("<P>\n<STRONG>$MesWordCount:</STRONG>\n<UL>\n");}
sub putslist{my($dblist)=@_;my($detail)=($Detail ne 'off' and %SubHit);my $ndx=-1;if (@Words){&output("<LI><STRONG>$dblist: $Keys</STRONG>: ") if $dblist;&message("<UL>\n") if $detail;foreach $_ (@Words){next if ++$ndx < $SubQueryWords && $Reference =~ /^off$/i;&message("<LI>\n") if $detail;if ($SubHit{$_} && $detail){&output(" [ $_: $Hit{$_} \(");&message("<UL>\n") if $detail;local($tmp)=$SubHit{$_};local(%tmp)=%$tmp;local(@Keys)=sort {$b <=> $a} keys(%tmp);$tmp='';foreach $key (@Keys){chop($tmp{$key});$tmp .= "<LI>" if $detail;$tmp .= "$key= $tmp{$key} \n";}chop($tmp);chop($tmp);$tmp .= "</UL>\n" if $detail;&output("$tmp\)] \n");}else{&output(" [ $_: $Hit{$_} ] ");}}&message("</UL>\n") if $detail;&message("\n");}}
sub puthlist{&message("</UL>\n</P>\n<P><STRONG>$MesTotal <!-- HIT -->$Keys<!-- HIT --> $MesDoc</STRONG></P>\n");if ($Keys){my($offset, $next, $summary, $dt, $st, $dd);&message("<DL>\n");foreach $key (@Keys){$keyno = $key, $keydb = '' unless ($keyno, $keydb) = split(/\#/, $key);
$offset=&indexpointer("FLISTINDEX$keydb", $keyno);$next=&lastSize("FLIST_____$keydb", $keyno + 1, "FLISTINDEX$keydb");($dt, $st, $summary, $dd)=split(/\n/, &readdb("FLIST_____$keydb", $offset, $next - $offset), 4);if($Whence < ++$Ndx){if ($Replace && $ReplaceFrom && $ReplaceTo){$st =~ s/$ReplaceFrom/$ReplaceTo/;$dd =~ s/$ReplaceFrom/$ReplaceTo/g;}&output("$dt$Ndx. $st (score: $Score{$key})\n") if $Format ne 'veryshort';&output("$summary\n") if $Format eq 'long';if ($DecodeURL){$dd =~ s/(\<A HREF=\")(.*?)(\")/$1.&decode_url($2).$3/ei;}elsif ($SplitLink){$dd =~ s/\<A HREF=\"(.*?)\"[^<]+<\/A>/&splitlink($1)/ei;}$dd =~ s/\n+/\n/g, $dd =~ s/ size \(\d.*$//g if $Format eq 'veryshort';&output("$dd");}last if ($Whence + $Max) <= $Ndx && $Max;}&message("</DL>\n");}}
sub splitlink{local($_)=@_;my($pre, $path, $ret);my(@elem, @link);if (s/^[a-zA-Z]+\:\/\/[^\/]*//){$pre=$&;}@elem=split(/\//, $_);$elem[0] .= $pre;while (defined($_=shift(@elem))){$_ .= '/' if scalar(@elem);$path .= $_;$ret .= "<A HREF=\"$path\">$_</A>";}$ret;}
sub putcurrentextent{if ($Keys){my($a, $b)=($Whence + 1, $Whence + $Max);$b=$Keys if ($b > $Keys || !$Max);&message(sprintf("<STRONG>Current List: %d - %d</STRONG><BR>\n",$a, $b));}}
sub putpagelink{my($num, $str)=@_;push(@OriginalQuery, "whence=$num") if !(grep {s/^whence.*/whence=$num/} @OriginalQuery) && $num;&output(sprintf("<A HREF=\"%s?%s\">[%s]</A>\n",$ENV{'SCRIPT_NAME'} . $PathInfo,join('&', @OriginalQuery),$str));}
sub putpageindex{if ($Max){my($PAGE_MAX, $num, $i)=(0, 0, 0);&message("<STRONG>Page:</STRONG> ") if $Keys;if ($Keys > $Whence){if ($Max && ($Whence >= $Max)){&putpagelink($Whence - $Max, "prev");}while ((!$PAGE_MAX || $i < $PAGE_MAX) && $num < $Keys){$i++;if ($num == $Whence){&output("<STRONG>[$i]</STRONG>\n");}else{&putpagelink($num, $i);}$num += $Max;}if ($Whence + $Max  < $Keys){&putpagelink($Whence + $Max, "next");}}}}
sub puthtmlheader{if ($Cgi && !$PutHead){$|=1;print "Last-Modified: $LastModified\n" if $LastModified;print "Content-Type: text/html\n\n";$PutHead=1;;}}
sub slog{my($rhost);local(*SLOG);$rhost=($ENV{'REMOTE_HOST'} || $ENV{'REMOTE_ADDR'});if (open(SLOG, ">>$DbPath.slog")){my($sec,$min,$hour,$mday,$mon,$year,$wday)=localtime(time);printf SLOG ("%s\t%d\t%s\t%s %s %2d %02d:%02d:%02d %4d\n",  $ARGV, $Keys, $rhost,('Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat')[$wday],('Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun','Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec')[$mon],$mday, $hour, $min, $sec, 1900+$year);close(SLOG);}}
sub main{$Cgi=($ENV{'GATEWAY_INTERFACE'} || !$CmdLineEna);$Replace=$LOGGING=1;$PageIndex=$PrintForm=$Cgi;$PlainConv=$DecodeURL=!$Cgi;&config;if ($Cgi){&load_namazu_conf;&cgiparamget;}else{&command_line_opt;&load_namazu_conf;}if ($LANGUAGE =~ /ja|jp|jis/i){$MesResults='検索結果', $MesWordCount='参考ヒット数',$MesTotal='検索式にマッチする', $MesDoc='個の項目が見つかりました。';}else{$MesResults='Results', $MesWordCount='Word count',  $MesTotal='Total', $MesDoc='documents match your query.';}&puthtmlheader;$IniPri=eval{getpriority(0, 0)};$SIG{'ALRM'}=\&alrm, alarm $ReniceTime if $Cgi && $ReniceTime > 0 && $RenicePri > 0;$DEFAULT_DIR .= '/' if $DEFAULT_DIR && $DEFAULT_DIR !~ /\/$/;if (@DbEnable){my(@tmp);for $tmp (@DbList){push(@tmp, $tmp) if grep {$tmp eq $_} @DbEnable;}@DbList=@tmp;}&remote_check(@DbList) if $REMOTE && $RemoteEnable;if ($MultiDb=(@DbList > 1 || @RemoteList)){$DbPath=$DEFAULT_DIR . $DbName;}else{if (@DbList){$DbPath=$DEFAULT_DIR . $DbList[0] . "/$DbName";}else{
$DbPath=$DEFAULT_DIR . $DbName;}}&openfiles($DbPath);if (($OrigARGV=$ARGV) =~ /\S/){if ($MultiDb){&headcat if !$PlainConv;&putsubmes;if (@DbList){for $dblist (@DbList){$DbList=&db_alias($dblist);next if $DbList =~ /^http\:\/\//;$DbPath=$DEFAULT_DIR . $DbList . "/$DbName";&pre_proc;&searchmain;&putslist($dblist);&slog if $LOGGING;&closedb($DbPath);$ARGV=$OrigARGV;}&searchsort;&puthlist;}if (@RemoteList){&remote_nmz();&output("<HR><BR>\n");}&putcurrentextent;&putpageindex if $PageIndex;}else{&pre_proc;&searchmain;&headcat if !$PlainConv;&putsubmes;&putslist;&searchsort;&puthlist;&putcurrentextent;&putpageindex if $PageIndex;&slog if $LOGGING;}}elsif (!$PlainConv){&headcat;if (&opentfile(*FH, "$DbPath.body")){&output(<FH>);close(FH);}}&output(@FOOT) if !$PlainConv && @FOOT;}
sub alrm{eval {setpriority(0, 0, $IniPri + $RenicePri);};}
sub db_alias{local($_)=@_;$_=$DbAlias{$_} if defined($DbAlias{$_});$_;}
&main;
